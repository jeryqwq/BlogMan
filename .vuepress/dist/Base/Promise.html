<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异步 | Promise | BlogMan</title>
    <meta name="description" content="曾今我也以为梦想遥不可及">
    
    
    <link rel="preload" href="/assets/css/0.styles.e1a66cd9.css" as="style"><link rel="preload" href="/assets/js/app.022ba49f.js" as="script"><link rel="preload" href="/assets/js/9.03c90539.js" as="script"><link rel="prefetch" href="/assets/js/10.d5ffb8d2.js"><link rel="prefetch" href="/assets/js/11.05f63d93.js"><link rel="prefetch" href="/assets/js/12.9e03cf6d.js"><link rel="prefetch" href="/assets/js/13.a919c644.js"><link rel="prefetch" href="/assets/js/14.b87d816e.js"><link rel="prefetch" href="/assets/js/15.c2352a98.js"><link rel="prefetch" href="/assets/js/16.e0083eb7.js"><link rel="prefetch" href="/assets/js/17.85966fd1.js"><link rel="prefetch" href="/assets/js/18.11c062c5.js"><link rel="prefetch" href="/assets/js/19.15e2a685.js"><link rel="prefetch" href="/assets/js/2.09acaf63.js"><link rel="prefetch" href="/assets/js/20.3eaff50a.js"><link rel="prefetch" href="/assets/js/21.810f2f33.js"><link rel="prefetch" href="/assets/js/22.fe22653c.js"><link rel="prefetch" href="/assets/js/23.865b0ffa.js"><link rel="prefetch" href="/assets/js/3.fbfa01cd.js"><link rel="prefetch" href="/assets/js/4.eed18581.js"><link rel="prefetch" href="/assets/js/5.9ba716b4.js"><link rel="prefetch" href="/assets/js/6.db58d49c.js"><link rel="prefetch" href="/assets/js/7.769b011c.js"><link rel="prefetch" href="/assets/js/8.ea5eb9c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e1a66cd9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BlogMan</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">前端</a></div><div class="nav-item"><a href="/guide/" class="nav-link">时间安排</a></div><div class="nav-item"><a href="https://github.com/jeryqwq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">前端</a></div><div class="nav-item"><a href="/guide/" class="nav-link">时间安排</a></div><div class="nav-item"><a href="https://github.com/jeryqwq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/Base/JS.html" class="sidebar-link">JS</a></li><li><a href="/Base/CSS.html" class="sidebar-link">CSS</a></li><li><a href="/Base/ES6.html" class="sidebar-link">ES6,ES7</a></li><li><a href="/Base/CMDAMD.html" class="sidebar-link">CMD | AMD 规范</a></li><li><a href="/Base/NODE.html" class="sidebar-link">Node.js</a></li><li><a href="/Base/Promise.html" class="active sidebar-link">异步 | Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Base/Promise.html#同步异步" class="sidebar-link">同步异步</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#promise用法" class="sidebar-link">Promise用法</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#链式promise" class="sidebar-link">链式Promise</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#promise-all" class="sidebar-link">Promise.all</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#async-await" class="sidebar-link">Async await</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#宏任务-macro-task" class="sidebar-link">宏任务 macro task</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#微任务-micor-task" class="sidebar-link">微任务 micor task</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#执行顺序" class="sidebar-link">执行顺序</a></li><li class="sidebar-sub-header"><a href="/Base/Promise.html#手写一个promise" class="sidebar-link">手写一个Promise</a></li></ul></li><li><a href="/Base/Render.html" class="sidebar-link">大话浏览器渲染原理</a></li><li><a href="/Base/Git.html" class="sidebar-link">Git</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架必知</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="同步异步"><a href="#同步异步" aria-hidden="true" class="header-anchor">#</a> 同步异步</h2> <ul><li>浏览器是多线程的，JS是单线程的（浏览器仅分配一个线程来执行JS，JS无法同时执行多个任务）</li> <li>多个线程组成一个进程，例如浏览器多个标签页面。线程用于执行JS代码就，加载Dom树，加载其他资源等。</li></ul> <h3 id="同步"><a href="#同步" aria-hidden="true" class="header-anchor">#</a> 同步</h3> <p>在一个线程上同一个时间只能做做一件事，当前事件完成才能进行下一个任务（先将任务推进队列，执行后出栈--先进先出）。</p> <h3 id="异步"><a href="#异步" aria-hidden="true" class="header-anchor">#</a> 异步</h3> <p>队列中执行任务，发现该任务是异步的，例如setTimeout、ajax、事件绑定、async/await、Promise等，js会将他移除任务队列，放入等待任务队列中，浏览器监听该异步任务是否有到指定的触发执行条件，如果主任务队列执行完后，浏览器监听会将已经满足异步触发条件的任务再次放入到任务队列中执行，所以JS中不可能出现同时执行多个任务。</p> <h2 id="promise用法"><a href="#promise用法" aria-hidden="true" class="header-anchor">#</a> Promise用法</h2> <p>从刚学前端的那会，记得那时候的异步控制还是使用callBack来控制，个人觉得callBack也挺好用的，也不会说什么存在什么回调地狱这种情况，可能是没有处理一些复杂的业务吧，直到后来promise，async await此处跳过中间还有个es7的叫什么名字忘记了，最后async await的问世才被成为js异步的终结者，大家开始使用这种方法来处理异步，前端感觉没怎么用到，koa、egg和express等后端框架中，async几乎成为各大node后端框架的标配。</p> <h3 id="callback"><a href="#callback" aria-hidden="true" class="header-anchor">#</a> callBack</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cbFn</span><span class="token punctuation">(</span><span class="token parameter">option<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">cbFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callBack'</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>过2秒后输出了callBack,123。</p> <h3 id="promise"><a href="#promise" aria-hidden="true" class="header-anchor">#</a> Promise</h3> <p>promise有三种状态：pedding,fulfilled,rejectd,初始化默认是padding等待状态，且只能从padding转换到fulfilled或者rejectd，其他两种状态无法做任何转换。当异步执行成功后使用reslove(result)来传递执行后的参数，失败使用reject(msg)来传递，当在执行过程中系统捕捉到错误时，默认抛出reject(err)。接收时使用.then.catch的语法来接收返回的数据。</p> <h4 id="then-reslove触发"><a href="#then-reslove触发" aria-hidden="true" class="header-anchor">#</a> then reslove触发</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> test<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'CJ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
test<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//  接收成功后的参数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕捉到错误：'</span><span class="token operator">+</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//两秒后打印CJ</span>
</code></pre></div><h4 id="catch-reject触发"><a href="#catch-reject触发" aria-hidden="true" class="header-anchor">#</a> catch reject触发</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> test<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//手动判定失败</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'这是手动判断的失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
test<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收成功后的参数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕捉到错误：'</span><span class="token operator">+</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收失败后的参数或者系统错误</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//两秒后打印：捕捉到错误：这是手动判断的失败</span>
</code></pre></div><h4 id="catch-捕捉错误"><a href="#catch-捕捉错误" aria-hidden="true" class="header-anchor">#</a> catch 捕捉错误</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> test<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'这是手动抛出的错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'CJ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
test<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收成功后的参数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕捉到错误：'</span><span class="token operator">+</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收失败后的参数或者系统错误</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//打印：捕捉到错误：Error: 这是手动抛出的错误</span>
</code></pre></div><h2 id="链式promise"><a href="#链式promise" aria-hidden="true" class="header-anchor">#</a> 链式Promise</h2> <p>Promise支持链式回调，then或者catch后可再次返回一个Promise可继续使用.then.catch的语法进行接收数据和处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">promise1</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'2秒后'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function-variable function">promise2</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'3秒后'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">promise1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">promise2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">//上一轮管控的异步方法只要没报错都执行此次函数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//2秒后 两秒后输出</span>
<span class="token comment">//3秒后 五秒后输出</span>

</code></pre></div><h2 id="promise-all"><a href="#promise-all" aria-hidden="true" class="header-anchor">#</a> Promise.all</h2> <p>Promise.all用于处理多个异步情况，处理时间取决于最长的异步处理时间，只有全部成功后才会跳转到then中，并传递一个数组存储多个promise执行后的结果，任何一个无论手动抛出还是捕捉到的错误都会执行到catch中捕捉到错误信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> test<span class="token operator">=</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
test<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>  <span class="token comment">// 两秒后输出[1, 2]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>当数组中的任何一个promise状态改变为reject或者捕捉到错误，会立即跳转到catch方法中且不执行其他的promise，故在错误的promise之后的其他promise都不执行，直接返回undefined</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> test<span class="token operator">=</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
test<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//仅输出1</span>
</code></pre></div><h2 id="async-await"><a href="#async-await" aria-hidden="true" class="header-anchor">#</a> Async await</h2> <p>层次深的promise感觉还是有点深层嵌套的感觉，一层套一层，直到ES8的 async await 的出现使js的异步更加易于书写，便于理解。只要在函数定义前加一个async关键词，说明该函数是一个异步函数，在定义异步变量前添加await，在此之后所有对该变量的引用都将等待所有异步获取的变量成功的reslove后。与Promise.all相似，运行时间取决于最长的异步的时间，要求更高的性能的话只能使用单独的promise进行异步流程控制。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">promise1</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' enter promise1'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1 exec'</span><span class="token punctuation">)</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'2秒后'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function-variable function">promise2</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' enter promise2'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2 exec'</span><span class="token punctuation">)</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'3秒后'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> result<span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">promise1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 先把await后的函数执行</span>
    <span class="token keyword">const</span> result2<span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">promise2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>result2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'begin'</span><span class="token punctuation">)</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// begin     //执行</span>
<span class="token comment">// enter promise1 //两秒后</span>
<span class="token comment">// promise1 exec  两秒后</span>
<span class="token comment">// enter promise2  两秒后</span>
<span class="token comment">// promise2 exec  三秒后</span>
<span class="token comment">// 2秒后   三秒后</span>
<span class="token comment">// 3秒后   三秒后</span>
<span class="token comment">// 2秒后 3秒后   三秒后</span>
</code></pre></div><p>发现async挺神奇的，总觉得他似乎能追踪到异步所执行的时间，我所认为的输出应该是begin=&gt;enter promise1=&gt;enter promise2=&gt;promise1 exec=&gt;promise2 exec=&gt;输出结果,但是它似乎好像追踪到了promise2的reslove的激活时间，promise1 exec和enter promise2竟然是同时输出的，可能内部已经提前运行了一遍。</p> <h2 id="宏任务-macro-task"><a href="#宏任务-macro-task" aria-hidden="true" class="header-anchor">#</a> 宏任务 macro task</h2> <ul><li>定时器</li> <li>事件绑定</li> <li>ajax</li> <li>回掉函数</li> <li>Node下fs模块文件读取操作</li></ul> <h2 id="微任务-micor-task"><a href="#微任务-micor-task" aria-hidden="true" class="header-anchor">#</a> 微任务 micor task</h2> <ul><li>Promise Promise并不是完全异步，只有在执行reslove或者reject的时候，此时才是异步，函数内的操作还是基于同步的;</li> <li>process.nextTick:优先于其他的异步操作。主任务队列之后，其他任务之前执行，例如做一些初始化并不影响系统服务正常开启的功能代码时。</li></ul> <h2 id="执行顺序"><a href="#执行顺序" aria-hidden="true" class="header-anchor">#</a> 执行顺序</h2> <p>在挂起任务时，JS 引擎会将所有任务按照类别分到这两个队列中，首先在 macrotask（宏任务） 的队列中取出第一个任务，执行完毕后取出 microtask（微任务）队列中的所有任务顺序执行；之后再取 macrotask 任务，周而复始，直至两个队列的任务都取完。执行顺序：同步任务=&gt;异步任务=&gt;宏任务=&gt;微任务</p> <h2 id="手写一个promise"><a href="#手写一个promise" aria-hidden="true" class="header-anchor">#</a> 手写一个Promise</h2> <h3 id="promise-a-规范"><a href="#promise-a-规范" aria-hidden="true" class="header-anchor">#</a> Promise A+规范</h3></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Base/NODE.html" class="prev">
          Node.js
        </a></span> <span class="next"><a href="/Base/Render.html">
          大话浏览器渲染原理
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.022ba49f.js" defer></script><script src="/assets/js/9.03c90539.js" defer></script>
  </body>
</html>
